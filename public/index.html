<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkpoint Collective</title>
    <link rel="icon" href="CP_Logo.png" type="image/jpeg">
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "8d4c0c13-12bb-436a-95d1-bd64eaa1a051",
          safari_web_id: "web.onesignal.auto.2c2f7f93-c22c-4405-a44b-05589b796f38",
          notifyButton: { enable: true },
        });
      });
    </script>
</head>
<body>

    <header class="app-header">
        <div class="header-logo">
            <span style="font-size:24px; color:#FF6B35;">C</span>heckpoint
        </div>
        <div class="header-user" id="headerUserEmail">Misafir</div>
    </header>

    <div id="loadingScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:flex; justify-content:center; align-items:center; z-index:9999;"><h2 style="color:#0B132B;">YÃ¼kleniyor...</h2></div>

    <div id="stravaSuccessScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; color:#333; display:none; flex-direction:column; justify-content:center; align-items:center; z-index:99999; text-align:center; padding:20px;">
        <h1 style="color:#4caf50; font-size:40px;">âœ…</h1><h2>BaÄŸlantÄ± BaÅŸarÄ±lÄ±!</h2><button onclick="window.close()" class="btn-primary" style="width:auto; margin-top:20px;">Pencereyi Kapat</button>
    </div>
    
    <div id="bugModal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3 style="color:#0B132B;">Bildirim</h3>
            <textarea id="bugText" rows="4" style="width:100%; border:1px solid #ccc; padding:10px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-primary" onclick="sendBugReport()">GÃ¶nder</button>
                <button class="btn-outline" onclick="closeBugModal()" style="border:none;">Ä°ptal</button>
            </div>
        </div>
    </div>
    
    <div id="checkinModal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3 style="color:#0B132B;">GÃ¼nlÃ¼k Check-in</h3>
            <div class="mood-selector">
                <span class="mood-option" onclick="selectMood(this, 1)">ğŸ˜©</span>
                <span class="mood-option" onclick="selectMood(this, 2)">ğŸ˜•</span>
                <span class="mood-option" onclick="selectMood(this, 3)">ğŸ˜</span>
                <span class="mood-option" onclick="selectMood(this, 4)">ğŸ™‚</span>
                <span class="mood-option" onclick="selectMood(this, 5)">ğŸš€</span>
            </div>
            <input type="hidden" id="checkinMood">
            <div class="range-container"><label style="color:#666;">Enerji: <span id="energyVal" style="color:#FF6B35">5</span>/10</label><input type="range" id="checkinEnergy" min="1" max="10" value="5" oninput="document.getElementById('energyVal').innerText=this.value"></div>
            <div class="input-group"><label>Uyku (Saat)</label><input type="number" id="checkinSleep"></div>
            <div class="remember-me-container"><input type="checkbox" id="checkinPain"><label for="checkinPain" style="color:#666;">AÄŸrÄ± var mÄ±?</label></div>
            <div style="display:flex; gap:10px;"><button class="btn-primary" onclick="saveCheckin()">Kaydet</button><button class="btn-outline" onclick="document.getElementById('checkinModal').style.display='none'">Ä°ptal</button></div>
        </div>
    </div>

    <div id="loginContainer" class="container login-container">
        <h1 style="color:#0B132B; font-size:32px;">HoÅŸ Geldin</h1>
        <p class="subtitle">HesabÄ±na giriÅŸ yap ve antrenmana baÅŸla.</p>
        <form id="loginForm">
            <div class="input-group"><label>E-Posta</label><input type="email" id="email" required></div>
            <div class="input-group"><label>Åifre</label><input type="password" id="password" required></div>
            <div class="remember-me-container"><input type="checkbox" id="rememberMe"><label for="rememberMe" style="color:#666;">Beni HatÄ±rla</label></div>
            <button type="submit" class="btn-primary">GÄ°RÄ°Å YAP</button>
        </form>
        <p class="footer-text">HesabÄ±n yok mu? <a onclick="ekranDegistir('kayit')">KayÄ±t Ol</a></p>
    </div>

    <div id="registerContainer" class="container hidden">
        <h1>KayÄ±t Ol</h1>
        <p class="subtitle">Checkpoint topluluÄŸuna katÄ±l.</p>
        <form id="registerForm">
            <div class="input-group"><label>Ad Soyad</label><input type="text" id="regName" required></div>
            <div class="input-group"><label>E-Posta</label><input type="email" id="regEmail" required></div>
            <div class="input-group"><label>Åifre</label><input type="password" id="regPass" required></div>
            <button type="submit" class="btn-primary">KAYIT OL</button>
        </form>
        <p class="footer-text"><a onclick="ekranDegistir('giris')">GiriÅŸ Yap</a></p>
    </div>

    <div id="adminPanel" class="container hidden">
        <h2 class="welcome-title" style="color:#0B132B;">Coach Paneli</h2>
        <div class="card">
            <div class="input-group"><label>Ã–ÄŸrenci SeÃ§:</label><select id="studentSelect" onchange="secilenOgrenciyiGetir()"><option>YÃ¼kleniyor...</option></select></div>
            <button class="btn-danger" onclick="ogrenciyiSil()" style="float:right; margin-top:-50px;">Sil</button>
        </div>
        
        <div id="pendingRacesList"></div>

        <div id="adminChartsArea" style="display:none;" class="card">
            <h4 style="font-size:12px;">HaftalÄ±k Hacim</h4>
            <canvas id="adminVolumeChart"></canvas>
        </div>

        <div id="adminLastCheckin" class="last-checkin-card" style="display:none; background:#F9FAFB; padding:10px; border-radius:8px; margin-bottom:20px;">
            <div class="checkin-emoji" id="adminCheckinEmoji" style="font-size:24px; margin-right:10px;"></div>
            <div><div class="checkin-label" style="font-size:10px; color:#888;">SON DURUM</div><div class="checkin-details" id="adminCheckinText" style="color:#333; font-size:13px;"></div></div>
        </div>

        <div class="card">
            <div class="input-group"><label>BugÃ¼nÃ¼n ProgramÄ± (<span id="bugunTarihAdmin"></span>):</label><textarea id="workoutInput" rows="4"></textarea></div>
            <div class="input-group">
                 <select id="templateSelect" onchange="sablonuUygula()">
                    <option value="">-- Åablon SeÃ§ --</option><option value="baslangic">ğŸ”° BaÅŸlangÄ±Ã§</option><option value="kardiyo">ğŸ”¥ Kardiyo</option><option value="bacak">ğŸ¦µ Bacak</option><option value="longrun">ğŸƒ Uzun KoÅŸu</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="kaydet()" style="flex:2;">YAYINLA</button>
                <button class="btn-primary" onclick="setRestDay()" style="flex:1; background:#9CA3AF;">OFF</button>
            </div>
        </div>
        
        <div class="card">
            <div class="view-toggle">
                <button class="toggle-btn active" id="btnViewWeekAdmin" onclick="changeViewAdmin('week')">Hafta</button>
                <button class="toggle-btn" id="btnViewMonthAdmin" onclick="changeViewAdmin('month')">Ay</button>
            </div>
            <div class="calendar-controls"><button class="cal-btn" onclick="changeDateAdmin(-1)">&#8249;</button><span class="cal-title" id="calTitleAdmin">...</span><button class="cal-btn" onclick="changeDateAdmin(1)">&#8250;</button></div>
            <div class="calendar-grid" id="calendarGridAdmin"></div>
            <div style="max-height:300px; overflow-y:auto; margin-top:20px;">
                <table class="history-table"><tbody id="adminHistoryTable"></tbody></table>
            </div>
        </div>
        <button class="btn-outline" onclick="cikisYap()">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>

    <div id="studentPanel" class="container hidden">
        <h2 id="studentNameTitle" class="welcome-title" style="color:#0B132B;">Merhaba!</h2>

        <div id="countdownBox" class="countdown-box" style="display:none;">
            <div style="font-size:12px; margin-bottom:5px; opacity:0.8;" id="targetRaceName">BÃœYÃœK GÃœNE</div>
            <div class="countdown-time" id="countdownTimer">00 GÃœN</div>
        </div>

        <div id="tab-workout" class="tab-content active-tab">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="chart-container" style="flex:1; padding:10px;">
                    <h4 style="font-size:10px; text-align:center;">Ä°stikrar</h4><canvas id="consistencyChart"></canvas>
                </div>
                <div class="chart-container" style="flex:2; padding:10px;">
                    <h4 style="font-size:10px; text-align:center;">HaftalÄ±k Km</h4><canvas id="volumeChart"></canvas>
                </div>
            </div>

            <button onclick="document.getElementById('checkinModal').style.display='flex'" class="btn-outline" style="margin-bottom:15px; border-style:dashed;">ğŸ“ BugÃ¼n NasÄ±l Hissediyorsun?</button>

            <div class="card">
                <h3 style="font-size:16px;">BugÃ¼nÃ¼n GÃ¶revi</h3>
                <div style="background:#F3F4F6; padding:15px; border-radius:8px; border-left:4px solid #FF6B35; min-height:60px; white-space:pre-line; margin-bottom:15px; color:#333;" id="workoutDisplay">YÃ¼kleniyor...</div>
                
                <a id="stravaConnectBtn" href="/auth/strava" target="_blank" class="btn-strava">ğŸ”— Strava BaÄŸla</a>
                <button class="btn-outline" onclick="syncStravaActivities()">ğŸ”„ Verileri Ã‡ek</button>
            </div>
            
            <div class="card">
                <h3 style="font-size:14px;">Harici Aktivite</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                     <select id="extraType" style="flex:1;"><option value="Yoga">ğŸ§˜ Yoga</option><option value="Pilates">ğŸ§˜â€â™€ï¸ Pilates</option><option value="Bisiklet">ğŸš´ Bisiklet</option></select>
                     <input type="text" id="extraNote" placeholder="SÃ¼re / Detay" style="flex:1;">
                </div>
                <button class="btn-primary" onclick="hariciEkle()">Ekle</button>
            </div>
        </div>

        <div id="tab-history" class="tab-content">
            <div class="card">
                <div class="view-toggle">
                    <button class="toggle-btn active" id="btnViewWeekStudent" onclick="changeViewStudent('week')">Hafta</button>
                    <button class="toggle-btn" id="btnViewMonthStudent" onclick="changeViewStudent('month')">Ay</button>
                </div>
                <div class="calendar-controls"><button class="cal-btn" onclick="changeDateStudent(-1)">&#8249;</button><span class="cal-title" id="calTitleStudent">...</span><button class="cal-btn" onclick="changeDateStudent(1)">&#8250;</button></div>
                <div id="dayHeadersStudent" style="display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:5px; font-size:10px; color:#888;"><div>Pzt</div><div>Sal</div><div>Ã‡ar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div></div>
                <div class="calendar-grid" id="calendarGridStudent"></div>
            </div>
            <div class="card"><div id="historyList" style="max-height:300px; overflow-y:auto;"></div></div>
        </div>

        <div id="tab-profile" class="tab-content">
            <div class="card">
                <h3>VÃ¼cut Ã–lÃ§Ã¼leri</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1"><label>Boy</label><input type="number" id="pBoy"></div>
                    <div style="flex:1"><label>Kilo</label><input type="number" id="pKilo"></div>
                </div>
                <div class="input-group"><label>YaÅŸ</label><input type="number" id="pYas"></div>
                <div class="input-group"><label>Hedef</label><input type="text" id="pHedef"></div>
                <button class="btn-primary" onclick="profiliGuncelle()">GÃ¼ncelle</button>
            </div>
            
            <div class="card">
                <h3>ğŸ† Hedef YarÄ±ÅŸ Ekle</h3>
                <div class="input-group"><label>YarÄ±ÅŸ AdÄ±</label><input type="text" id="raceName" placeholder="Ã–rn: Ä°stanbul Maratonu"></div>
                <div class="input-group"><label>Tarih</label><input type="date" id="raceDate"></div>
                <button class="btn-primary" onclick="requestRace()">Onaya GÃ¶nder</button>
            </div>
            <button class="bug-btn" onclick="openBugModal()" style="display:block; margin:20px auto;">ğŸ› Hata Bildir</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('tab-workout', this)"><span class="nav-icon">ğŸ‹ï¸</span>Antrenman</div>
            <div class="nav-item" onclick="switchTab('tab-history', this)"><span class="nav-icon">ğŸ“…</span>GeÃ§miÅŸ</div>
            <div class="nav-item" onclick="switchTab('tab-profile', this)"><span class="nav-icon">ğŸ‘¤</span>Profil</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // --- AYARLAR (BURAYI KENDÄ° BÄ°LGÄ°LERÄ°NLE DOLDUR) ---
     const firebaseConfig = {
  apiKey: "AIzaSyAMi1g8d-nUagKV1bMjSjtOyJKX19s76BY",
  authDomain: "checkpoint-app-1abcd.firebaseapp.com",
  projectId: "checkpoint-app-1abcd",
  storageBucket: "checkpoint-app-1abcd.firebasestorage.app",
  messagingSenderId: "840395107034",
  appId: "1:840395107034:web:08492488e1a20205a293e3"
};
        
        const EMAILJS_PUBLIC_KEY = "u86YX7H03kFzxPSeZ"; 
        const EMAILJS_SERVICE_ID = "service_inrl3js";
        const EMAILJS_TEMPLATE_ID = "template_b5u758v";
        const COACH_EMAIL = "cpnoktasi@gmail.com";


        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) {}

        let studentCalDate = new Date(); let studentCalView = 'week';
        let adminCalDate = new Date(); let adminCalView = 'week';
        let adminSelectedUserEmail = null;
        const bugun = new Date().toISOString().split('T')[0];
        let volumeChartInstance = null; let consistencyChartInstance = null;

        if(document.getElementById('bugunTarihAdmin')) document.getElementById('bugunTarihAdmin').innerText = bugun;

        const screens = { giris: 'loginContainer', kayit: 'registerContainer', admin: 'adminPanel', ogrenci: 'studentPanel' };
        function ekranDegistir(hedef) { Object.values(screens).forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById(screens[hedef]).classList.remove('hidden'); }
        function switchTab(tabId, btn) { 
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab')); 
            document.getElementById(tabId).classList.add('active-tab'); 
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
            btn.classList.add('active'); 
            if(tabId==='tab-history') renderUniversalCalendar(auth.currentUser.email, 'student');
        }

        window.onload = function() {
            document.getElementById('loadingScreen').style.display='none';
            const urlParams = new URLSearchParams(window.location.search);
            const t = urlParams.get('strava_token');
            if(t) {
                auth.onAuthStateChanged(u => {
                    if(u) db.collection("users").doc(u.email).update({ stravaConnected:true, stravaAccessToken:t }).then(()=>{ window.history.replaceState({},'', '/'); document.getElementById('stravaSuccessScreen').style.display='flex'; });
                }); return;
            }
            if(localStorage.getItem('adminLogged')==='true') { ekranDegistir('admin'); adminListesiniYukle(); return; }
            auth.onAuthStateChanged(u => {
                if(u && localStorage.getItem('adminLogged')!=='true') {
                    if (window.OneSignalDeferred) window.OneSignalDeferred.push(function(OS) { OS.login(u.email); });
                    document.getElementById('headerUserEmail').innerText = u.email;
                    loadStudentData(u.email);
                }
            });
        };

        // --- GRAFÄ°KLER ---
        async function updateCharts(email) {
            const historyRef = db.collection("users").doc(email).collection("history");
            const snap = await historyRef.get();
            let weeklyVolume = [0,0,0,0]; let totalDone = 0; let totalPlanned = 0;
            snap.forEach(doc => {
                const d = doc.data();
                if(d.durum === 'tamamlandi' && d.km) weeklyVolume[3] += d.km;
                if(d.program && d.program !== 'Rest Day') totalPlanned++;
                if(d.durum === 'tamamlandi') totalDone++;
            });

            const chartConfig = (ctx, type, data, options) => {
                Chart.defaults.color = '#1F1F1F'; Chart.defaults.borderColor = '#E5E7EB';
                return new Chart(ctx, { type, data, options });
            };

            const ctxVol = document.getElementById(auth.currentUser ? 'volumeChart' : 'adminVolumeChart');
            if(ctxVol) {
                if(volumeChartInstance) volumeChartInstance.destroy();
                volumeChartInstance = chartConfig(ctxVol, 'bar', {
                    labels: ['3 Hft', '2 Hft', '1 Hft', 'Bu Hft'],
                    datasets: [{ label: 'Km', data: [15, 22, 18, weeklyVolume[3]], backgroundColor: '#FF6B35', borderRadius: 4 }]
                }, { plugins: { legend: {display:false} }, scales: { y: { beginAtZero:true } } });
            }

            const ctxCon = document.getElementById('consistencyChart');
            if(ctxCon) {
                if(consistencyChartInstance) consistencyChartInstance.destroy();
                consistencyChartInstance = chartConfig(ctxCon, 'doughnut', {
                    labels: ['YapÄ±ldÄ±', 'KaÃ§tÄ±'],
                    datasets: [{ data: [totalDone||1, (totalPlanned-totalDone)], backgroundColor: ['#2ECC71', '#E5E7EB'], borderWidth:0 }]
                }, { cutout: '75%', plugins: { legend: {display:false} } });
            }
        }

        // --- STRAVA SENKRONÄ°ZASYON ---
        async function syncStravaActivities() {
            const user = auth.currentUser; if(!user) return;
            const doc = await db.collection("users").doc(user.email).get();
            let data = doc.data();
            if(!data.stravaConnected) return alert("Ã–nce Strava'yÄ± baÄŸla!");
            
            let accessToken = data.stravaAccessToken;
            const now = Math.floor(Date.now() / 1000);

            if(data.stravaExpires && data.stravaExpires < now) {
                console.log("Token yenileniyor...");
                const refreshRes = await fetch('/api/strava/refresh', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ refresh_token: data.stravaRefreshToken }) });
                const refreshData = await refreshRes.json();
                accessToken = refreshData.access_token;
                await db.collection("users").doc(user.email).update({ stravaAccessToken: accessToken, stravaRefreshToken: refreshData.refresh_token, stravaExpires: refreshData.expires_at });
            }

            const actRes = await fetch('/api/strava/activities', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ access_token: accessToken }) });
            const activities = await actRes.json();
            let addedCount = 0; const historyRef = db.collection("users").doc(user.email).collection("history");

            for(let act of activities) {
                if(act.type === 'Run') {
                    const date = act.start_date.split('T')[0];
                    const km = (act.distance / 1000).toFixed(2);
                    const time = Math.round(act.moving_time / 60);
                    await historyRef.doc(date).set({ tarih: date, program: `Strava: ${act.name}`, durum: 'tamamlandi', tamamlanmaZamani: new Date(), stravaLink: `https://www.strava.com/activities/${act.id}`, km: parseFloat(km), sure: time }, { merge: true });
                    addedCount++;
                }
            }
            alert(`${addedCount} aktivite senkronize edildi! ğŸ“Š`); updateCharts(user.email);
        }

        // --- YARIÅ SÄ°STEMÄ° ---
        function requestRace() {
            const name = document.getElementById('raceName').value; const date = document.getElementById('raceDate').value;
            if(!name || !date) return alert("Bilgileri girin.");
            db.collection("race_requests").add({ user: auth.currentUser.email, name: name, date: date, status: 'pending' }).then(() => alert("Onaya gÃ¶nderildi! ğŸ†"));
        }
        function loadPendingRaces() {
            const list = document.getElementById('pendingRacesList'); if(!list) return; list.innerHTML = "";
            db.collection("race_requests").where("status", "==", "pending").get().then(snap => {
                snap.forEach(doc => {
                    const r = doc.data();
                    const div = document.createElement('div');
                    div.style.cssText = "background:#FFF5F5; border-left:4px solid #FFBC42; padding:10px; margin-bottom:10px; font-size:13px; text-align:left; border:1px solid #E5E7EB; border-radius:4px;";
                    div.innerHTML = `<strong>${r.user}</strong> yarÄ±ÅŸ: ${r.name} (${r.date}) <button onclick="approveRace('${doc.id}', '${r.user}', '${r.name}', '${r.date}')" style="font-size:10px; padding:3px; background:#38B2AC; color:white; border:none; cursor:pointer;">Onayla</button>`;
                    list.appendChild(div);
                });
            });
        }
        function approveRace(docId, email, name, date) {
            db.collection("users").doc(email).update({ targetRaceName: name, targetRaceDate: date });
            db.collection("users").doc(email).collection("history").doc(date).set({ program: `ğŸ† ${name}`, durum: 'race', tarih: date });
            db.collection("race_requests").doc(docId).update({ status: 'approved' });
            alert("OnaylandÄ±!"); loadPendingRaces();
        }

        // --- TAKVÄ°M ---
        function renderUniversalCalendar(email, role) {
            let currentDate = (role === 'student') ? studentCalDate : adminCalDate;
            let currentView = (role === 'student') ? studentCalView : adminCalView;
            let gridId = (role === 'student') ? 'calendarGridStudent' : 'calendarGridAdmin';
            let listId = (role === 'student') ? 'historyList' : 'adminHistoryTable';
            let titleId = (role === 'student') ? 'calTitleStudent' : 'calTitleAdmin';
            let headersId = (role === 'student') ? 'dayHeadersStudent' : null;

            const grid = document.getElementById(gridId); const list = document.getElementById(listId); const title = document.getElementById(titleId);
            grid.innerHTML = "YÃ¼kleniyor..."; 
            if(list.tagName === 'TBODY') list.innerHTML = ""; else list.innerHTML = "";
            if(headersId) document.getElementById(headersId).style.display = (currentView === 'year') ? 'none' : 'grid';

            let datesToRender = [];
            if (currentView === 'week') {
                grid.className = "calendar-grid";
                let day = currentDate.getDay(); let diff = currentDate.getDate() - day + (day == 0 ? -6 : 1); 
                let startDate = new Date(currentDate); startDate.setDate(diff);
                title.innerText = `${startDate.getDate()} - ${new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()+6).getDate()} ${startDate.toLocaleDateString('tr-TR', { month: 'long' })}`;
                for(let i=0; i<7; i++) { let d=new Date(startDate); d.setDate(startDate.getDate()+i); datesToRender.push(d.toISOString().split('T')[0]); }
            } else if(currentView === 'month') {
                grid.className = "calendar-grid";
                title.innerText = currentDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
                let startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                let firstDay=startDate.getDay(); if(firstDay===0)firstDay=7; for(let i=1; i<firstDay; i++) datesToRender.push("empty");
                let daysInMonth=new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
                for(let i=1; i<=daysInMonth; i++) { let d=new Date(currentDate.getFullYear(), currentDate.getMonth(), i); let y=d.getFullYear(); let m=String(d.getMonth()+1).padStart(2,'0'); let dd=String(d.getDate()).padStart(2,'0'); datesToRender.push(`${y}-${m}-${dd}`); }
            } else if(currentView === 'year') {
                grid.className = "calendar-grid"; // YÄ±l gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in basit liste veya grid
                title.innerText = currentDate.getFullYear();
                // Basit YÄ±l GÃ¶rÃ¼nÃ¼mÃ¼ (Sadece aylar)
                for(let i=0; i<12; i++) datesToRender.push({ monthIndex: i, year: currentDate.getFullYear() });
            }

            db.collection("users").doc(email).collection("history").get().then(snapshot => {
                let historyMap = {}; snapshot.forEach(doc => { historyMap[doc.id] = doc.data(); });
                grid.innerHTML = "";
                
                if(currentView === 'year') {
                    // YÄ±l GÃ¶rÃ¼nÃ¼mÃ¼ Render
                    const monthNames = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
                    datesToRender.forEach(item => {
                        grid.innerHTML += `<div class="day-card" style="width:auto;">${monthNames[item.monthIndex]}</div>`;
                    });
                } else {
                    datesToRender.forEach(dateStr => {
                        if(dateStr === "empty") { grid.innerHTML += `<div class="day-card day-other-month"></div>`; return; }
                        let statusClass="", content="", dayNum=dateStr.split('-')[2];
                        if(dateStr===bugun) statusClass+=" day-today";
                        let hasData=false, item=null;
                        if(historyMap[dateStr]) {
                            hasData=true; item=historyMap[dateStr];
                            if(item.durum==='tamamlandi'){statusClass+=" day-done"; content="âœ…";}
                            else if(item.durum==='rest'){statusClass+=" day-rest"; content="ğŸ’¤";}
                            else{statusClass+=" day-missed"; content="ğŸ”´";}
                        }
                        grid.innerHTML += `<div class="day-card ${statusClass}" onclick="alert('${dateStr}')"><div style="color:#888;margin-bottom:2px;">${parseInt(dayNum)}</div><div>${content}</div></div>`;
                        
                        if(hasData) {
                            let html = `<div><strong>${dateStr}</strong>: ${item.program} (${item.durum})</div>`;
                            if(list.tagName==='TBODY') list.innerHTML += `<tr><td>${dateStr}</td><td>${item.program}</td><td>${item.durum}</td></tr>`;
                            else list.innerHTML += `<div style="background:white; padding:10px; margin-bottom:5px; border-radius:8px; border:1px solid #eee;">${html}</div>`;
                        }
                    });
                }
                if(list.innerHTML==="" && currentView !== 'year') list.innerHTML = (list.tagName==='TBODY') ? "<tr><td colspan='3'>KayÄ±t yok.</td></tr>" : "<p style='color:#666'>KayÄ±t yok.</p>";
            });
        }

        // --- DÄ°ÄERLERÄ° (AYNI) ---
        function selectMood(el, val) { document.querySelectorAll('.mood-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); document.getElementById('checkinMood').value = val; }
        function saveCheckin() { 
            const m = document.getElementById('checkinMood').value; 
            if(!m) return alert("Ruh hali seÃ§.");
            const u = auth.currentUser;
            db.collection("users").doc(u.email).collection("checkins").doc(bugun).set({date:bugun, mood:m, timestamp:new Date()}).then(()=>{
                alert("Kaydedildi."); document.getElementById('checkinModal').style.display='none';
            });
        }
        function sendMail(to, sub, msg) { if(EMAILJS_PUBLIC_KEY !== "BURAYA_EMAILJS_KEY") emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {to_email: to, subject: sub, message: msg}); }
        function openBugModal() { document.getElementById('bugModal').style.display = 'flex'; }
        function closeBugModal() { document.getElementById('bugModal').style.display = 'none'; }
        function sendBugReport() { db.collection("bug_reports").add({user: auth.currentUser?.email, note:document.getElementById('bugText').value, time:new Date()}).then(()=>{alert("GÃ¶nderildi");closeBugModal();}); }
        document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('email').value.trim().toLowerCase(); if(email==='cpnoktasi@gmail.com' && document.getElementById('password').value==='cp2025') { ekranDegistir('admin'); adminListesiniYukle(); return; } auth.signInWithEmailAndPassword(email, document.getElementById('password').value).then(c => { if(c.user.emailVerified) loadStudentData(email); else { alert("Mail onayla!"); auth.signOut(); } }).catch(e => alert(e.message)); });
        document.getElementById('registerForm').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('regEmail').value.trim(); auth.createUserWithEmailAndPassword(email, document.getElementById('regPass').value).then((c) => { c.user.sendEmailVerification(); db.collection("users").doc(email).set({ isim: document.getElementById('regName').value, email: email, rol: 'ogrenci', stravaConnected:false }).then(() => { alert("KayÄ±t BaÅŸarÄ±lÄ±! Mailini onayla."); auth.signOut(); ekranDegistir('giris'); }); }).catch(e => alert(e.message)); });
        function hariciEkle() { const type=document.getElementById('extraType').value; const note=document.getElementById('extraNote').value; if(note){ const user=auth.currentUser; const text=`â• ${type} (${note})`; db.collection("users").doc(user.email).collection("history").doc(bugun).get().then(doc=>{ let newData={ekstra: doc.exists && doc.data().ekstra ? doc.data().ekstra+", "+text : text, durum: doc.exists && doc.data().durum==='rest'?'active-rest':'tamamlandi'}; if(!doc.exists){newData.tarih=bugun; newData.program="Serbest Aktivite";} db.collection("users").doc(user.email).collection("history").doc(bugun).set(newData, {merge:true}).then(()=>{ alert("Eklendi!"); renderUniversalCalendar(user.email,'student'); }); }); } }
        function setRestDay() { db.collection("users").doc(document.getElementById('studentSelect').value).collection("history").doc(bugun).set({program:"Rest Day", durum:"rest", tarih:bugun}).then(()=>alert("OFF")); }
        function profiliGuncelle() { const user=auth.currentUser; if(user) db.collection("users").doc(user.email).update({boy:document.getElementById('pBoy').value, kilo:document.getElementById('pKilo').value, yas:document.getElementById('pYas').value, hedef:document.getElementById('pHedef').value}).then(()=>alert("Kaydedildi")); }
        function goreviTamamla() { const user=auth.currentUser; const link=document.getElementById('stravaLinkInput').value; if(user) db.collection("users").doc(user.email).collection("history").doc(bugun).update({durum:'tamamlandi', tamamlanmaZamani:new Date(), stravaLink:link}).then(()=>{ alert("Kaydedildi!"); renderUniversalCalendar(user.email,'student'); }).catch(()=>alert("Program yok")); }
        function adminListesiniYukle(){ const sel=document.getElementById('studentSelect'); sel.innerHTML="<option>YÃ¼kleniyor...</option>"; db.collection("users").where("rol","==","ogrenci").get().then(s=>{ sel.innerHTML=""; s.forEach(d=>{ let o=document.createElement('option'); o.value=d.id; o.text=d.data().isim; sel.appendChild(o); }); secilenOgrenciyiGetir(); }); }
        function secilenOgrenciyiGetir(){ const id=document.getElementById('studentSelect').value; if(!id)return; adminSelectedUserEmail=id; adminCalDate=new Date(); db.collection("users").doc(id).get().then(d=>{ document.getElementById('studentStats').style.display='block'; document.getElementById('studentStats').innerHTML=`Boy:${d.data().boy}`; updateCharts(id); renderUniversalCalendar(id,'admin'); }); }
        function kaydet(){ const id=document.getElementById('studentSelect').value; const p=document.getElementById('workoutInput').value; if(id) db.collection("users").doc(id).collection("history").doc(bugun).set({program:p, durum:'bekliyor', tarih:bugun}).then(()=>{ alert("YayÄ±nlandÄ±!"); }); }
        function ogrenciyiSil(){ if(confirm("Sil?")) db.collection("users").doc(document.getElementById('studentSelect').value).delete().then(()=>adminListesiniYukle()); }
        function sablonuUygula(){ const v=document.getElementById('templateSelect').value; const s={"baslangic":"ğŸ”° BAÅLANGIÃ‡\n- 10dk YÃ¼rÃ¼yÃ¼ÅŸ\n- 3x12 Squat","kardiyo":"ğŸ”¥ KARDÄ°YO\n- 20dk KoÅŸu","bacak":"ğŸ¦µ BACAK\n- 4x12 Squat","longrun":"ğŸƒ UZUN KOÅU\n- 60dk","interval":"âš¡ Ä°NTERVAL\n- 8x 2dk"}; if(s[v])document.getElementById('workoutInput').value=s[v]; }
        function cikisYap(){ localStorage.removeItem('adminLogged'); auth.signOut().then(()=>location.reload()); }
        // KONTROL BUTONLARI
        function changeViewStudent(v){studentCalView=v; renderUniversalCalendar(auth.currentUser.email,'student');}
        function changeDateStudent(d){ if(studentCalView==='week') studentCalDate.setDate(studentCalDate.getDate()+d*7); else studentCalDate.setMonth(studentCalDate.getMonth()+d); renderUniversalCalendar(auth.currentUser.email,'student'); }
        function changeViewAdmin(v){adminCalView=v; if(adminSelectedUserEmail) renderUniversalCalendar(adminSelectedUserEmail,'admin');}
        function changeDateAdmin(d){ if(adminCalView==='week') adminCalDate.setDate(adminCalDate.getDate()+d*7); else adminCalDate.setMonth(adminCalDate.getMonth()+d); if(adminSelectedUserEmail) renderUniversalCalendar(adminSelectedUserEmail,'admin'); }
    </script>
</body>
</html>