<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkpoint Collective</title>
    <link rel="icon" href="CP_Logo.png" type="image/jpeg">
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "8d4c0c13-12bb-436a-95d1-bd64eaa1a051",
          safari_web_id: "web.onesignal.auto.2c2f7f93-c22c-4405-a44b-05589b796f38",
          notifyButton: { enable: true },
        });
      });
    </script>
</head>
<body>

    <div id="loadingScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0B132B; color:white; display:flex; justify-content:center; align-items:center; z-index:9999;"><h2>YÃ¼kleniyor...</h2></div>

    <div id="bugModal" class="modal-overlay" style="display:none;"><div class="modal-box"><h3 style="color:#FF6B35;">Bildirim</h3><textarea id="bugText" rows="4" style="width:100%;background:#333;color:white;border:none;"></textarea><button class="btn-primary" onclick="sendBugReport()">GÃ¶nder</button><button class="btn-primary" onclick="closeBugModal()" style="background:#444;">Kapat</button></div></div>

    <div id="loginContainer" class="container">
        <img src="CP_Logo.png" alt="Logo" class="logo" style="width:150px; margin-bottom:20px;">
        <h1>GiriÅŸ Yap</h1>
        <form id="loginForm">
            <div class="input-group"><label>E-Posta</label><input type="email" id="email" required></div>
            <div class="input-group"><label>Åifre</label><input type="password" id="password" required></div>
            <div class="remember-me-container"><input type="checkbox" id="rememberMe"><label for="rememberMe">Beni HatÄ±rla</label></div>
            <button type="submit" class="btn-primary">GÄ°RÄ°Å YAP</button>
        </form>
        <p class="footer-text"><a onclick="ekranDegistir('kayit')">KayÄ±t Ol</a></p>
    </div>

    <div id="registerContainer" class="container hidden">
        <h1>KayÄ±t Ol</h1>
        <form id="registerForm">
            <div class="input-group"><label>Ad Soyad</label><input type="text" id="regName" required></div>
            <div class="input-group"><label>E-Posta</label><input type="email" id="regEmail" required></div>
            <div class="input-group"><label>Åifre</label><input type="password" id="regPass" required></div>
            <button type="submit" class="btn-primary">KAYIT OL</button>
        </form>
        <p class="footer-text"><a onclick="ekranDegistir('giris')">GiriÅŸ Yap</a></p>
    </div>

    <div id="adminPanel" class="container hidden">
        <h2 class="welcome-title">Coach Paneli</h2>
        <div class="input-group">
            <label>Ã–ÄŸrenci SeÃ§:</label>
            <select id="studentSelect" onchange="secilenOgrenciyiGetir()" style="width:100%; padding:10px; background:#1F1F1F; color:white; border:1px solid #333; border-radius:5px;"><option>YÃ¼kleniyor...</option></select>
        </div>
        
        <div id="pendingRacesList"></div>

        <div id="adminChartsArea" style="display:none; margin-bottom:20px;">
            <div class="chart-container" style="background:#1F1F1F; padding:10px; border-radius:10px;">
                <h4 style="color:#FF6B35; font-size:12px; margin-bottom:5px;">HaftalÄ±k Hacim</h4>
                <canvas id="adminVolumeChart"></canvas>
            </div>
        </div>

        <div class="input-group">
            <label>BugÃ¼nÃ¼n ProgramÄ± (<span id="bugunTarihAdmin"></span>):</label>
            <textarea id="workoutInput" rows="4"></textarea>
        </div>
        <div class="input-group">
             <select id="templateSelect" onchange="sablonuUygula()">
                <option value="">-- Åablon SeÃ§ --</option>
                <option value="baslangic">ğŸ”° BaÅŸlangÄ±Ã§</option>
                <option value="kardiyo">ğŸ”¥ Kardiyo</option>
                <option value="bacak">ğŸ¦µ Bacak</option>
                <option value="longrun">ğŸƒ Uzun KoÅŸu</option>
            </select>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-primary" onclick="kaydet()" style="flex:2;">YAYINLA</button>
            <button class="btn-primary" onclick="setRestDay()" style="flex:1; background:#4A90E2;">ğŸ’¤ OFF</button>
        </div>
        
        <div style="margin-top:30px;"><h3 style="font-size:16px;">ğŸ“… Takvim</h3><div class="calendar-grid" id="calendarGridAdmin"></div></div>
        
        <button class="btn-primary" style="background:#333; margin-top:20px;" onclick="cikisYap()">Ã‡IKIÅ</button>
    </div>

    <div id="studentPanel" class="container hidden" style="padding:20px 20px 0 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 id="studentNameTitle" class="welcome-title" style="margin:0; font-size:20px;">Merhaba!</h2>
            <button onclick="cikisYap()" style="background:#333; border:none; color:white; padding:5px 10px; border-radius:5px; font-size:12px;">Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div id="countdownBox" class="countdown-box" style="display:none; background: linear-gradient(135deg, #FF6B35, #E55A2B); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);">
            <div style="font-size:12px; margin-bottom:5px;" id="targetRaceName">BÃœYÃœK GÃœNE</div>
            <div class="countdown-time" id="countdownTimer" style="font-size: 24px; font-weight: bold; font-family: 'Bebas Neue', sans-serif;">00 GÃœN</div>
        </div>

        <div id="tab-workout" class="tab-content active-tab">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="chart-container" style="flex:1; background:#1F1F1F; padding:5px; border-radius:5px;">
                    <h4 style="font-size:10px; text-align:center; color:#888;">Ä°stikrar</h4>
                    <canvas id="consistencyChart"></canvas>
                </div>
                <div class="chart-container" style="flex:2; background:#1F1F1F; padding:5px; border-radius:5px;">
                    <h4 style="font-size:10px; text-align:center; color:#888;">HaftalÄ±k Km</h4>
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <h3 style="font-size:16px; color:#fff; text-align:left;">BugÃ¼nÃ¼n GÃ¶revi</h3>
            <div style="background:#1F1F1F; padding:20px; border-radius:10px; text-align:left; border-left:4px solid #FF6B35; min-height:80px; white-space:pre-line; margin-bottom:10px;" id="workoutDisplay">YÃ¼kleniyor...</div>
            
            <a id="stravaConnectBtn" href="/auth/strava" style="display:block; background:#FC4C02; color:white; padding:10px; border-radius:8px; text-decoration:none; font-weight:bold; margin-bottom:10px;">ğŸ”— Strava BaÄŸla</a>
            
            <button class="btn-sync" onclick="syncStravaActivities()" style="background-color: #252525; border: 1px solid #FF6B35; color: #FF6B35; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">ğŸ”„ Strava'yÄ± EÅŸitle</button>
            
            <hr style="border:1px solid #333; margin:20px 0;">
            
            <h3 style="font-size:14px; color:#FF6B35; text-align:left; margin-bottom:10px;">Harici Aktivite Ekle</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                 <select id="extraType" style="flex:1; padding:8px;"><option value="Yoga">ğŸ§˜ Yoga</option><option value="Pilates">ğŸ§˜â€â™€ï¸ Pilates</option><option value="Bisiklet">ğŸš´ Bisiklet</option></select>
                 <input type="text" id="extraNote" placeholder="SÃ¼re / Detay" style="flex:1; padding:8px;">
            </div>
            <button class="btn-primary" style="background:#444; margin-top:0;" onclick="hariciEkle()">Ekle â•</button>
        </div>

        <div id="tab-history" class="tab-content">
            <h3 style="font-size:16px; color:#fff; text-align:left;">Takvim</h3>
            <div class="calendar-controls" style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button class="cal-btn" onclick="changeDateStudent(-1)">&#8249;</button>
                <span class="cal-title" id="calTitleStudent">...</span>
                <button class="cal-btn" onclick="changeDateStudent(1)">&#8250;</button>
            </div>
            <div class="calendar-grid" id="calendarGridStudent"></div>
            <div id="historyList" style="max-height:300px; overflow-y:auto;"></div>
        </div>

        <div id="tab-profile" class="tab-content">
            <h3 style="font-size:16px; color:#FF6B35; text-align:left;">Profil & Hedef</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1"><label>Boy</label><input type="number" id="pBoy"></div>
                <div style="flex:1"><label>Kilo</label><input type="number" id="pKilo"></div>
            </div>
            <div class="input-group"><label>YaÅŸ</label><input type="number" id="pYas"></div>
            <div class="input-group"><label>Hedef</label><input type="text" id="pHedef"></div>
            <button class="btn-primary" onclick="profiliGuncelle()" style="background:#444;">Bilgileri GÃ¼ncelle</button>
            
            <hr style="border:1px solid #333; margin:20px 0;">
            
            <h3 style="font-size:16px; color:#FF6B35; text-align:left;">ğŸ† Hedef YarÄ±ÅŸ Ekle</h3>
            <div class="input-group"><label>YarÄ±ÅŸ AdÄ±</label><input type="text" id="raceName" placeholder="Ã–rn: Ä°stanbul Maratonu"></div>
            <div class="input-group"><label>Tarih</label><input type="date" id="raceDate" style="background:#252525; color:white; padding:8px; width:100%;"></div>
            <button class="btn-primary" onclick="requestRace()">Onaya GÃ¶nder</button>
            
            <button class="bug-btn" onclick="openBugModal()" style="display:block; margin:30px auto; text-align:center;">ğŸ› Hata / Ã–neri Bildir</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('tab-workout', this)"><span class="nav-icon">ğŸ‹ï¸</span></div>
            <div class="nav-item" onclick="switchTab('tab-history', this)"><span class="nav-icon">ğŸ“…</span></div>
            <div class="nav-item" onclick="switchTab('tab-profile', this)"><span class="nav-icon">ğŸ‘¤</span></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // --- AYARLAR (BURAYI KENDÄ° BÄ°LGÄ°LERÄ°NLE DOLDUR) ---
     const firebaseConfig = {
  apiKey: "AIzaSyAMi1g8d-nUagKV1bMjSjtOyJKX19s76BY",
  authDomain: "checkpoint-app-1abcd.firebaseapp.com",
  projectId: "checkpoint-app-1abcd",
  storageBucket: "checkpoint-app-1abcd.firebasestorage.app",
  messagingSenderId: "840395107034",
  appId: "1:840395107034:web:08492488e1a20205a293e3"
};
        
        const EMAILJS_PUBLIC_KEY = "u86YX7H03kFzxPSeZ"; 
        const EMAILJS_SERVICE_ID = "service_inrl3js";
        const EMAILJS_TEMPLATE_ID = "template_b5u758v";
        const COACH_EMAIL = "cpnoktasi@gmail.com";



        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) {}

        let studentCalDate = new Date();
        const bugun = new Date().toISOString().split('T')[0];
        if(document.getElementById('bugunTarihAdmin')) document.getElementById('bugunTarihAdmin').innerText = bugun;

        // --- CHART NESNELERÄ° ---
        let volumeChartInstance = null;
        let consistencyChartInstance = null;

        const screens = { giris: 'loginContainer', kayit: 'registerContainer', admin: 'adminPanel', ogrenci: 'studentPanel' };
        function ekranDegistir(hedef) { Object.values(screens).forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById(screens[hedef]).classList.remove('hidden'); }
        function switchTab(tabId, btn) { 
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab')); 
            document.getElementById(tabId).classList.add('active-tab'); 
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
            btn.classList.add('active'); 
            if(tabId==='tab-history') renderCalendar(auth.currentUser.email);
        }

        window.onload = function() {
            document.getElementById('loadingScreen').style.display='none';
            if(localStorage.getItem('adminLogged')==='true') { ekranDegistir('admin'); adminListesiniYukle(); return; }
            auth.onAuthStateChanged(u => {
                if(u && localStorage.getItem('adminLogged')!=='true') {
                    if (window.OneSignalDeferred) window.OneSignalDeferred.push(function(OS) { OS.login(u.email); });
                    const urlParams = new URLSearchParams(window.location.search);
                    const t = urlParams.get('strava_token'); const r = urlParams.get('strava_refresh'); const e = urlParams.get('strava_expires');
                    if(t) {
                        db.collection("users").doc(u.email).update({ stravaConnected:true, stravaAccessToken:t, stravaRefreshToken:r, stravaExpires:e })
                        .then(()=>{ window.history.replaceState({},'', '/'); location.reload(); });
                    } else loadStudentData(u.email);
                }
            });
        };

        // --- OTOMATÄ°K STRAVA SENKRONÄ°ZASYONU ---
        async function syncStravaActivities() {
            const user = auth.currentUser;
            if(!user) return;
            
            const doc = await db.collection("users").doc(user.email).get();
            let data = doc.data();
            
            if(!data.stravaConnected) return alert("Ã–nce Strava'yÄ± baÄŸla!");
            
            let accessToken = data.stravaAccessToken;
            const now = Math.floor(Date.now() / 1000);

            if(data.stravaExpires && data.stravaExpires < now) {
                console.log("Token sÃ¼resi bitmiÅŸ, yenileniyor...");
                const refreshRes = await fetch('/api/strava/refresh', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ refresh_token: data.stravaRefreshToken })
                });
                const refreshData = await refreshRes.json();
                accessToken = refreshData.access_token;
                await db.collection("users").doc(user.email).update({
                    stravaAccessToken: accessToken,
                    stravaRefreshToken: refreshData.refresh_token,
                    stravaExpires: refreshData.expires_at
                });
            }

            const actRes = await fetch('/api/strava/activities', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ access_token: accessToken })
            });
            const activities = await actRes.json();

            let addedCount = 0;
            const historyRef = db.collection("users").doc(user.email).collection("history");

            for(let act of activities) {
                if(act.type === 'Run') {
                    const date = act.start_date.split('T')[0];
                    const km = (act.distance / 1000).toFixed(2);
                    const time = Math.round(act.moving_time / 60); 
                    
                    await historyRef.doc(date).set({
                        tarih: date,
                        program: `Strava: ${act.name}`,
                        durum: 'tamamlandi',
                        tamamlanmaZamani: new Date(),
                        stravaLink: `https://www.strava.com/activities/${act.id}`,
                        km: parseFloat(km),
                        sure: time
                    }, { merge: true });
                    addedCount++;
                }
            }
            
            alert(`${addedCount} aktivite senkronize edildi! Grafikler gÃ¼ncelleniyor... ğŸ“Š`);
            updateCharts(user.email);
        }

        // --- YARIÅ SÄ°STEMÄ° ---
        function requestRace() {
            const name = document.getElementById('raceName').value;
            const date = document.getElementById('raceDate').value;
            if(!name || !date) return alert("Bilgileri girin.");
            const user = auth.currentUser;
            
            db.collection("race_requests").add({
                user: user.email, name: name, date: date, status: 'pending'
            }).then(() => alert("Onaya gÃ¶nderildi! ğŸ†"));
        }

        function loadPendingRaces() {
            const list = document.getElementById('pendingRacesList');
            if(!list) return;
            list.innerHTML = "";
            
            db.collection("race_requests").where("status", "==", "pending").get().then(snap => {
                if(snap.empty) return;
                snap.forEach(doc => {
                    const r = doc.data();
                    const div = document.createElement('div');
                    div.style.cssText = "background:#333; border-left:4px solid #FFBC42; padding:10px; margin-bottom:10px; font-size:13px; text-align:left;";
                    div.innerHTML = `
                        <strong>${r.user}</strong> yarÄ±ÅŸ eklemek istiyor:<br>ğŸ ${r.name} (${r.date})<br>
                        <button onclick="approveRace('${doc.id}', '${r.user}', '${r.name}', '${r.date}')" style="font-size:10px; padding:3px; background:green; color:white; border:none; cursor:pointer; margin-top:5px;">Onayla</button>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function approveRace(docId, email, name, date) {
            db.collection("users").doc(email).update({ targetRaceName: name, targetRaceDate: date });
            db.collection("users").doc(email).collection("history").doc(date).set({
                program: `ğŸ† ${name}`, durum: 'race', tarih: date
            });
            db.collection("race_requests").doc(docId).update({ status: 'approved' });
            alert("OnaylandÄ±!"); loadPendingRaces();
        }

        // --- GRAFÄ°KLER ---
        async function updateCharts(email) {
            const historyRef = db.collection("users").doc(email).collection("history");
            const snap = await historyRef.get();
            
            let weeklyVolume = [0,0,0,0];
            let totalDone = 0; let totalPlanned = 0;

            snap.forEach(doc => {
                const d = doc.data();
                if(d.durum === 'tamamlandi' && d.km) weeklyVolume[3] += d.km;
                if(d.program && d.program !== 'Rest Day') totalPlanned++;
                if(d.durum === 'tamamlandi') totalDone++;
            });

            const ctxVol = document.getElementById(auth.currentUser ? 'volumeChart' : 'adminVolumeChart');
            if(ctxVol) {
                if(volumeChartInstance) volumeChartInstance.destroy();
                volumeChartInstance = new Chart(ctxVol, {
                    type: 'bar',
                    data: { labels: ['3 Hft', '2 Hft', '1 Hft', 'Bu Hft'], datasets: [{ label: 'Km', data: [15, 22, 18, weeklyVolume[3]], backgroundColor: '#FF6B35' }] },
                    options: { scales: { y: { beginAtZero: true, grid: { color: '#333' } } } }
                });
            }

            const ctxCon = document.getElementById('consistencyChart');
            if(ctxCon) {
                if(consistencyChartInstance) consistencyChartInstance.destroy();
                consistencyChartInstance = new Chart(ctxCon, {
                    type: 'doughnut',
                    data: { labels: ['YapÄ±ldÄ±', 'KaÃ§tÄ±'], datasets: [{ data: [totalDone, (totalPlanned-totalDone)], backgroundColor: ['#4caf50', '#333'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: { legend: { display: false } } }
                });
            }
        }

        // --- DÄ°ÄER FONKSÄ°YONLAR ---
        function loadStudentData(email) {
            db.collection("users").doc(email).get().then(doc => {
                if(doc.exists) {
                    ekranDegistir('ogrenci');
                    const veri = doc.data();
                    document.getElementById('studentNameTitle').innerText = "Merhaba, " + veri.isim.split(' ')[0];
                    if(veri.targetRaceDate) {
                        document.getElementById('countdownBox').style.display = 'block';
                        document.getElementById('targetRaceName').innerText = veri.targetRaceName.toUpperCase() + "'NA KALAN";
                        const diff = new Date(veri.targetRaceDate) - new Date();
                        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                        document.getElementById('countdownTimer').innerText = days + " GÃœN";
                    }
                    const stravaBtn = document.getElementById('stravaConnectBtn');
                    if (veri.stravaConnected && stravaBtn) {
                        stravaBtn.innerHTML = "âœ… Strava BaÄŸlÄ±"; stravaBtn.style.background = "#4caf50"; stravaBtn.href = "#"; stravaBtn.style.pointerEvents = "none";
                    }
                    updateCharts(email);
                    const historyRef = db.collection("users").doc(email).collection("history");
                    historyRef.doc(bugun).onSnapshot(doc => {
                        if(doc.exists) document.getElementById('workoutDisplay').innerText = doc.data().program;
                        else document.getElementById('workoutDisplay').innerText = "BugÃ¼n antrenman yok.";
                    });
                    renderCalendar(email);
                } else { auth.signOut(); }
            });
        }

        // BÄ°LDÄ°RÄ°M FONKSÄ°YONU
        function sendPushNotification(targetEmail, message) {
            fetch('/api/send-notification', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetEmail: targetEmail, message: message })
            }).then(res => console.log("Bildirim GÃ¶nderildi"));
        }

        function adminListesiniYukle() {
            const select = document.getElementById('studentSelect');
            select.innerHTML = "<option>YÃ¼kleniyor...</option>";
            db.collection("users").where("rol", "==", "ogrenci").get().then(snap => {
                select.innerHTML = "";
                snap.forEach(doc => { let opt = document.createElement('option'); opt.value = doc.id; opt.text = doc.data().isim; select.appendChild(opt); });
                secilenOgrenciyiGetir(); loadPendingRaces();
            });
        }

        function renderCalendar(email) {
            const grid = document.getElementById(auth.currentUser ? 'calendarGridStudent' : 'calendarGridAdmin');
            const list = document.getElementById(auth.currentUser ? 'historyList' : 'adminHistoryTable'); // Basit ID
            grid.innerHTML = "YÃ¼kleniyor..."; 
            
            let curr = new Date(); let first = curr.getDate() - curr.getDay() + 1; 
            if(curr.getDay()===0) first=curr.getDate()-6;
            
            let dates=[]; for(let i=0;i<7;i++) { let d=new Date(curr); d.setDate(first+i); dates.push(d.toISOString().split('T')[0]); }

            db.collection("users").doc(email).collection("history").get().then(snap => {
                let map={}; snap.forEach(d=>{ map[d.id]=d.data(); });
                grid.innerHTML=""; list.innerHTML=""; // Liste admin iÃ§in tablo, Ã¶ÄŸrenci iÃ§in div olabilir
                let displayDays = ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"];

                dates.forEach((d,i) => {
                    let st="âšª", cls="day-card"; if(d===bugun) cls+=" day-today";
                    if(map[d]){ if(map[d].durum==='tamamlandi'){st="âœ…"; cls+=" day-done";} else if(map[d].durum==='race'){st="ğŸ†"; cls+=" day-race";} else st="ğŸ”´"; }
                    grid.innerHTML+=`<div class="${cls}"><div class="day-header">${displayDays[i]}</div><div style="font-size:16px;">${st}</div></div>`;
                });
            });
        }

        // --- STANDART FONKSÄ°YONLAR ---
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault(); const email = document.getElementById('regEmail').value.trim();
            auth.createUserWithEmailAndPassword(email, document.getElementById('regPass').value).then((c) => {
                c.user.sendEmailVerification();
                db.collection("users").doc(email).set({ isim: document.getElementById('regName').value, email: email, rol: 'ogrenci', stravaConnected: false }).then(() => {
                    alert("KayÄ±t BaÅŸarÄ±lÄ±! Mailini onayla."); auth.signOut(); ekranDegistir('giris');
                });
            }).catch(e => alert(e.message));
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault(); const email = document.getElementById('email').value.trim().toLowerCase();
            if(email==='cpnoktasi@gmail.com' && document.getElementById('password').value==='cp2025') { ekranDegistir('admin'); adminListesiniYukle(); if(window.OneSignalDeferred) window.OneSignalDeferred.push(function(OS){ OS.login(email); }); return; }
            auth.signInWithEmailAndPassword(email, document.getElementById('password').value).then(c => {
                if(c.user.emailVerified) loadStudentData(email); else { alert("Mail onayla!"); auth.signOut(); }
            }).catch(e => alert(e.message));
        });

        function kaydet(){ 
            const id=document.getElementById('studentSelect').value; const p=document.getElementById('workoutInput').value; if(!id)return; 
            db.collection("users").doc(id).collection("history").doc(bugun).set({program:p, durum:'bekliyor', tarih:bugun}).then(()=>{ alert("YayÄ±nlandÄ±!"); sendPushNotification(id, "Yeni ProgramÄ±n HazÄ±r! ğŸƒâ€â™‚ï¸"); }); 
        }
        function cikisYap(){ localStorage.removeItem('adminLogged'); if(window.OneSignalDeferred) window.OneSignalDeferred.push(function(OS){ OS.logout(); }); auth.signOut().then(()=>location.reload()); }
        function openBugModal(){document.getElementById('bugModal').style.display='flex';} function closeBugModal(){document.getElementById('bugModal').style.display='none';}
        function sendBugReport(){ db.collection("bug_reports").add({user:auth.currentUser?.email||"Misafir", note:document.getElementById('bugText').value, time:new Date()}).then(()=>{alert("GÃ¶nderildi");closeBugModal();}); }
        function hariciEkle(){ const t=`â• ${document.getElementById('extraType').value} (${document.getElementById('extraNote').value})`; db.collection("users").doc(auth.currentUser.email).collection("history").doc(bugun).set({ekstra:t, durum:'tamamlandi', tarih:bugun}, {merge:true}).then(()=>{alert("Eklendi"); sendPushNotification(COACH_EMAIL, "Ekstra Aktivite YaptÄ±m! ğŸ§˜");}); }
        function setRestDay(){ db.collection("users").doc(document.getElementById('studentSelect').value).collection("history").doc(bugun).set({program:"Rest Day", durum:"rest", tarih:bugun}).then(()=>alert("OFF")); }
        function secilenOgrenciyiGetir(){ const id=document.getElementById('studentSelect').value; if(!id)return; db.collection("users").doc(id).get().then(d=>{ updateCharts(id); }); }
        function sablonuUygula(){ const s={"baslangic":"ğŸ”° BAÅLANGIÃ‡\n- 10dk YÃ¼rÃ¼yÃ¼ÅŸ\n- 3x12 Squat","kardiyo":"ğŸ”¥ KARDÄ°YO\n- 20dk KoÅŸu","bacak":"ğŸ¦µ BACAK\n- 4x12 Squat","longrun":"ğŸƒ UZUN KOÅU\n- 60dk","interval":"âš¡ Ä°NTERVAL\n- 8x 2dk"}; document.getElementById('workoutInput').value=s[document.getElementById('templateSelect').value]; }
    </script>
</body>
</html>