<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkpoint Collective</title>
    <link rel="icon" href="CP_Logo.png" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        /* --- 1. GENEL AYARLAR --- */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        body {
            background-color: #0B132B; font-family: 'Inter', sans-serif; color: #FFFFFF;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding: 20px; padding-bottom: 90px;
        }
        .hidden { display: none !important; }
        .container { width: 100%; max-width: 450px; margin: 0 auto; text-align: center; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 2. G√ñRSEL VE Tƒ∞POGRAFƒ∞ --- */
        .logo { width: 160px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 20px; }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; color: #FFFFFF; margin-bottom: 10px; letter-spacing: 0.5px; }
        .subtitle { color: #EDEDED; font-size: 14px; margin-bottom: 30px; opacity: 0.8; }
        .welcome-title { color: #FF6B35; margin-bottom: 15px; }

        /* --- 3. FORMLAR --- */
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #EDEDED; font-weight: 600; text-transform: uppercase; }
        input, select, textarea {
            width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #333;
            background-color: #1F1F1F; color: #FFFFFF; font-family: 'Inter', sans-serif;
            font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: #FF6B35; box-shadow: 0 0 8px rgba(255, 107, 53, 0.2); }
        
        .remember-me-container { display: flex; align-items: center; margin-bottom: 20px; cursor: pointer; text-align: left; }
        .remember-me-container input { width: auto; margin-right: 10px; accent-color: #FF6B35; transform: scale(1.2); }
        .remember-me-container label { margin-bottom: 0; cursor: pointer; text-transform: none; font-size: 14px; color: #ccc; }

        /* --- 4. BUTONLAR --- */
        .btn-primary {
            width: 100%; padding: 16px; background-color: #FF6B35; color: #FFFFFF;
            border: none; border-radius: 10px; font-family: 'Poppins', sans-serif;
            font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px;
            transition: transform 0.2s;
        }
        .btn-primary:active { transform: scale(0.97); }
        .btn-danger { background-color: #d32f2f; width: auto; padding: 10px 15px; margin-left: 5px; }
        
        a { color: #FF6B35; text-decoration: none; font-weight: bold; cursor: pointer; }
        .footer-text { margin-top: 20px; font-size: 13px; color: #888; }
        .bug-btn { background: none; border: none; color: #666; font-size: 11px; cursor: pointer; text-decoration: underline; margin-top: 15px; transition: 0.3s; }
        .bug-btn:hover { color: #FF6B35; }

        /* --- 5. ALT MEN√ú --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background-color: #161b2e;
            border-top: 1px solid #333; display: flex; justify-content: space-around;
            padding: 12px 0; z-index: 1000; backdrop-filter: blur(10px);
        }
        .nav-item { color: #888; text-align: center; cursor: pointer; flex: 1; font-size: 11px; font-family: 'Poppins', sans-serif; transition: 0.3s; }
        .nav-item.active { color: #FF6B35; font-weight: bold; transform: translateY(-2px); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }
        .tab-content { display: none; animation: fadeIn 0.3s; padding-bottom: 20px; }
        .tab-content.active-tab { display: block; }

        /* --- 6. TAKVƒ∞M --- */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #1F1F1F; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .cal-btn { background: none; border: none; color: #FF6B35; font-size: 20px; cursor: pointer; }
        .cal-title { font-weight: bold; font-size: 14px; }
        .view-toggle { display: flex; background: #1F1F1F; border-radius: 8px; overflow: hidden; margin-bottom: 15px; border: 1px solid #333; }
        .toggle-btn { flex: 1; border: none; background: none; color: #888; padding: 10px; cursor: pointer; font-size: 12px; }
        .toggle-btn.active { background: #FF6B35; color: white; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 20px; }
        .day-header { text-align: center; font-size: 10px; color: #666; padding-bottom: 5px; }
        .day-card {
            background: #1F1F1F; border-radius: 6px; padding: 5px; text-align: center;
            min-height: 45px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; border: 1px solid #333; font-size: 12px; cursor: pointer; transition: 0.2s;
        }
        .day-other-month { opacity: 0.3; }
        .day-today { border-color: #FF6B35 !important; box-shadow: 0 0 8px rgba(255, 107, 53, 0.3); }
        .day-done { background: rgba(76, 175, 80, 0.2); border-color: #4caf50; color: #a5d6a7; }
        .day-missed { background: rgba(244, 67, 54, 0.15); border-color: #d32f2f; color: #ef9a9a; }
        .day-rest { background: rgba(158, 158, 158, 0.15); border-color: #9e9e9e; color: #ccc; }
        .day-active-rest { background: rgba(221, 160, 221, 0.15); border-color: #DDA0DD; color: #DDA0DD; }

        /* --- 7. Lƒ∞STE VE TABLO --- */
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .history-table td { padding: 12px 8px; border-bottom: 1px solid #333; color: #ccc; vertical-align: top; }
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; display: inline-block; margin-bottom: 5px; text-transform: uppercase; }
        .bg-green { background: #2e7d32; color: white; }
        .bg-red { background: #c62828; color: white; }
        .bg-gray { background: #616161; color: white; }
        .bg-purple { background: #7B1FA2; color: white; }
        .coach-note { font-size: 11px; color: #FFBC42; font-style: italic; display: block; margin-top: 4px; border-left: 2px solid #FFBC42; padding-left: 6px;}
        .extra-activity { font-size: 11px; color: #DDA0DD; font-weight: bold; display: block; margin-top: 4px; }
        .strava-btn { color: #FC4C02; font-weight: bold; text-decoration: none; font-size: 11px; border: 1px solid #FC4C02; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; }
        .comment-btn { background: none; border: 1px solid #555; color: #aaa; cursor: pointer; border-radius: 4px; padding: 3px 8px; font-size: 10px; margin-top: 5px; }

        /* --- 8. MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-box { background: #161b2e; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; border: 1px solid #FF6B35; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .bug-item { background: #1F1F1F; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #d32f2f; font-size: 12px; }
        .bug-meta { color: #888; font-size: 10px; margin-bottom: 4px; display: block; }
    </style>
</head>
<body>

    <div id="bugModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#FF6B35; margin-bottom:10px;">‚ö†Ô∏è Sorun Bildir</h3>
            <textarea id="bugText" rows="4" placeholder="Sorunu buraya yaz..." style="width:100%; padding:10px; background:#252525; color:white; border:1px solid #444; border-radius:5px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-primary" onclick="sendBugReport()" style="margin-top:0;">G√∂nder</button>
                <button class="btn-primary" onclick="closeBugModal()" style="margin-top:0; background:#444;">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <div id="loginContainer" class="container">
        <img src="CP_Logo.png" alt="Checkpoint Logo" class="logo">
        <h1>Giri≈ü Yap</h1>
        <form id="loginForm">
            <div class="input-group"><label>E-Posta</label><input type="email" id="email" required></div>
            <div class="input-group"><label>≈ûifre</label><input type="password" id="password" required></div>
            <div class="remember-me-container">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Beni Hatƒ±rla</label>
            </div>
            <button type="submit" class="btn-primary">Gƒ∞Rƒ∞≈û YAP</button>
        </form>
        <p class="footer-text"><a onclick="ekranDegistir('kayit')">Kayƒ±t Ol</a></p>
        <button class="bug-btn" onclick="openBugModal()">‚ö†Ô∏è Bir sorun mu var? Bildir.</button>
    
    </div>

    <div id="registerContainer" class="container hidden">
        <h1>Kayƒ±t Ol</h1>
        <form id="registerForm">
            <div class="input-group"><label>Ad Soyad</label><input type="text" id="regName" required></div>
            <div class="input-group"><label>E-Posta</label><input type="email" id="regEmail" required></div>
            <div class="input-group"><label>≈ûifre</label><input type="password" id="regPass" required></div>
            <button type="submit" class="btn-primary">KAYIT OL</button>
        </form>
        <p class="footer-text"><a onclick="ekranDegistir('giris')">Giri≈ü Yap</a></p>
    </div>

    <div id="adminPanel" class="container hidden">
        <h2 class="welcome-title">Coach Paneli</h2>
        <div class="input-group">
            <label>√ñƒürenci Se√ß:</label>
            <div style="display:flex;">
                <select id="studentSelect" onchange="secilenOgrenciyiGetir()"><option>Y√ºkleniyor...</option></select>
                <button class="btn-primary btn-danger" onclick="ogrenciyiSil()" style="width:50px; margin-left:5px;">üóëÔ∏è</button>
            </div>
        </div>
        <div id="studentStats" style="background:#252525; padding:15px; border-radius:10px; margin-bottom:20px; display:none; text-align:left; border-left: 3px solid #FF6B35;"></div>
        <div class="input-group">
            <label>Bug√ºn√ºn Programƒ± (<span id="bugunTarihAdmin"></span>):</label>
            <textarea id="workoutInput" rows="4"></textarea>
        </div>
        <div class="input-group">
             <select id="templateSelect" onchange="sablonuUygula()">
                <option value="">-- Hƒ±zlƒ± ≈ûablon --</option>
                <option value="baslangic">üî∞ Ba≈ülangƒ±√ß</option>
                <option value="kardiyo">üî• Kardiyo</option>
                <option value="bacak">ü¶µ Bacak</option>
                <option value="longrun">üèÉ Uzun Ko≈üu</option>
                <option value="interval">‚ö° ƒ∞nterval</option>
            </select>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-primary" onclick="kaydet()" style="flex:2;">YAYINLA üöÄ</button>
            <button class="btn-primary" onclick="setRestDay()" style="flex:1; background:#4A90E2;">üí§ OFF</button>
        </div>
        
        <div style="margin-top:30px; text-align:left;">
            <h3 style="font-size:16px; color:#fff;">üìÖ √ñƒürenci Takvimi</h3>
            <div class="view-toggle">
                <button class="toggle-btn active" id="btnViewWeekAdmin" onclick="changeViewAdmin('week')">Haftalƒ±k</button>
                <button class="toggle-btn" id="btnViewMonthAdmin" onclick="changeViewAdmin('month')">Aylƒ±k</button>
            </div>
            <div class="calendar-controls">
                <button class="cal-btn" onclick="changeDateAdmin(-1)">&#8249;</button>
                <span class="cal-title" id="calTitleAdmin">...</span>
                <button class="cal-btn" onclick="changeDateAdmin(1)">&#8250;</button>
            </div>
            <div class="calendar-grid" id="calendarGridAdmin"></div>
            <h4 style="color:#FF6B35; font-size:12px; margin-bottom:5px;">D√∂nem √ñzeti</h4>
            <div style="max-height:300px; overflow-y:auto; background:#1F1F1F; border-radius:10px; padding:10px;">
                <table class="history-table"><tbody id="adminHistoryTable"></tbody></table>
            </div>
        </div>

        <div style="margin-top:30px; text-align:left;">
            <h3 style="font-size:16px; color:#d32f2f;">üêõ Gelen Bildirimler</h3>
            <div id="bugReportList" style="max-height:200px; overflow-y:auto; border-top:1px solid #333; padding-top:10px;"></div>
        </div>
        <button class="btn-primary" style="background:#333; margin-top:20px;" onclick="cikisYap()">√áIKI≈û</button>
    </div>

    <div id="studentPanel" class="container hidden" style="padding:20px 20px 0 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="studentNameTitle" class="welcome-title" style="margin:0; font-size:20px;">Merhaba!</h2>
            <button onclick="cikisYap()" style="background:#333; border:none; color:white; padding:5px 10px; border-radius:5px; font-size:12px;">√áƒ±kƒ±≈ü</button>
        </div>

        <div id="tab-workout" class="tab-content active-tab">
            <h3 style="font-size:16px; color:#fff; text-align:left;">Bug√ºn√ºn G√∂revi (<span id="bugunTarihOgrenci"></span>)</h3>
            <div style="background:#1F1F1F; padding:20px; border-radius:10px; text-align:left; border-left:4px solid #FF6B35; min-height:100px; white-space:pre-line; margin-bottom:15px;" id="workoutDisplay">Y√ºkleniyor...</div>
            
            <a id="stravaConnectBtn" href="/auth/strava" style="display:block; background:#FC4C02; color:white; padding:15px; border-radius:10px; text-decoration:none; font-weight:bold; margin-bottom:20px;">
                üîó Strava ile Baƒülan
            </a>

            <button class="btn-primary" onclick="goreviTamamla()">Kaydet ve Tamamla ‚úÖ</button>
            
            <hr style="border:1px solid #333; margin:20px 0;">
            <h3 style="font-size:14px; color:#FF6B35; text-align:left; margin-bottom:10px;">Harici Aktivite Ekle</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                 <select id="extraType" style="flex:1;">
                     <option value="Yoga">üßò Yoga</option>
                     <option value="Pilates">üßò‚Äç‚ôÄÔ∏è Pilates</option>
                     <option value="Bisiklet">üö¥ Bisiklet</option>
                     <option value="Y√ºzme">üèä Y√ºzme</option>
                     <option value="Y√ºr√ºy√º≈ü">üö∂ Y√ºr√ºy√º≈ü</option>
                     <option value="Diƒüer">‚ú® Diƒüer</option>
                 </select>
                 <input type="text" id="extraNote" placeholder="S√ºre / Detay" style="flex:1;">
            </div>
            <button class="btn-primary" style="background:#444; margin-top:0;" onclick="hariciEkle()">Aktiviteyi Kaydet ‚ûï</button>
            <div style="margin-top:20px; background: linear-gradient(45deg, #FF6B35, #FFBC42); padding:15px; border-radius:10px; color:#0B132B; font-weight:bold;">
                üî• Seri: <span id="streakCount">0</span> G√ºn
            </div>
        </div>

        <div id="tab-history" class="tab-content">
            <h3 style="font-size:16px; color:#fff; text-align:left;">Takvim</h3>
            <div class="view-toggle">
                <button class="toggle-btn active" id="btnViewWeekStudent" onclick="changeViewStudent('week')">Haftalƒ±k</button>
                <button class="toggle-btn" id="btnViewMonthStudent" onclick="changeViewStudent('month')">Aylƒ±k</button>
            </div>
            <div class="calendar-controls">
                <button class="cal-btn" onclick="changeDateStudent(-1)">&#8249;</button>
                <span class="cal-title" id="calTitleStudent">...</span>
                <button class="cal-btn" onclick="changeDateStudent(1)">&#8250;</button>
            </div>
            <div style="display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:5px;">
                <div class="day-header">Pzt</div><div class="day-header">Sal</div><div class="day-header">√áar</div><div class="day-header">Per</div><div class="day-header">Cum</div><div class="day-header">Cmt</div><div class="day-header">Paz</div>
            </div>
            <div class="calendar-grid" id="calendarGridStudent"></div>
            <h4 style="color:#FF6B35; font-size:12px; margin-bottom:5px;">D√∂nem Detaylarƒ±</h4>
            <div style="max-height:300px; overflow-y:auto; background:#1F1F1F; border-radius:10px; padding:10px;">
                <table class="history-table"><tbody id="studentHistoryTable"></tbody></table>
            </div>
        </div>

        <div id="tab-profile" class="tab-content">
            <h3 style="font-size:16px; color:#FF6B35; text-align:left;">V√ºcut √ñl√ß√ºleri</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1"><label>Boy</label><input type="number" id="pBoy"></div>
                <div style="flex:1"><label>Kilo</label><input type="number" id="pKilo"></div>
            </div>
            <div class="input-group"><label>Ya≈ü</label><input type="number" id="pYas"></div>
            <div class="input-group"><label>Hedef</label><input type="text" id="pHedef"></div>
            <button class="btn-primary" onclick="profiliGuncelle()" style="background:#444;">G√ºncelle</button>
            <button class="bug-btn" onclick="openBugModal()" style="display:block; margin:30px auto; text-align:center;">üêõ Hata / √ñneri Bildir</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('tab-workout', this)"><span class="nav-icon">üèãÔ∏è</span>Antrenman</div>
            <div class="nav-item" onclick="switchTab('tab-history', this)"><span class="nav-icon">üìÖ</span>Ge√ßmi≈ü</div>
            <div class="nav-item" onclick="switchTab('tab-profile', this)"><span class="nav-icon">üë§</span>Profil</div>
        </div>
    </div>

    <script>
        // --- AYARLAR (BURAYI KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞NLE DOLDUR) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAMi1g8d-nUagKV1bMjSjtOyJKX19s76BY", // Senin Firebase anahtarƒ±n
            authDomain: "checkpoint-app-1abcd.firebaseapp.com",
            projectId: "checkpoint-app-1abcd",
            storageBucket: "checkpoint-app-1abcd.firebasestorage.app",
            messagingSenderId: "840395107034",
            appId: "1:840395107034:web:08492488e1a20205a293e3"
        };
        
        const EMAILJS_PUBLIC_KEY = "USER_ID_BURAYA"; // EmailJS Public Key
        const EMAILJS_SERVICE_ID = "SERVICE_ID_BURAYA"; // EmailJS Service ID
        const EMAILJS_TEMPLATE_ID = "TEMPLATE_ID_BURAYA"; // EmailJS Template ID
        const COACH_EMAIL = "senin_gercek_mailin@gmail.com"; // Ko√ß Maili

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) { console.log("EmailJS ba≈ülatƒ±lamadƒ±."); }

        // Deƒüi≈ükenler
        let studentCalDate = new Date(); let studentCalView = 'week';
        let adminCalDate = new Date(); let adminCalView = 'week';
        let adminSelectedUserEmail = null;

        // Tarih Fonksiyonu
        function getBugunTarihi() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        const bugun = getBugunTarihi();
        
        if(document.getElementById('bugunTarihAdmin')) document.getElementById('bugunTarihAdmin').innerText = bugun;
        if(document.getElementById('bugunTarihOgrenci')) document.getElementById('bugunTarihOgrenci').innerText = bugun;

        // Ekran Ge√ßi≈üleri
        const screens = {
            giris: document.getElementById('loginContainer'),
            kayit: document.getElementById('registerContainer'),
            admin: document.getElementById('adminPanel'),
            ogrenci: document.getElementById('studentPanel')
        };

        function ekranDegistir(hedef) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[hedef].classList.remove('hidden');
        }
        
        function switchTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(tabId).classList.add('active-tab');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btnElement.classList.add('active');
            if(tabId === 'tab-history' && auth.currentUser) renderUniversalCalendar(auth.currentUser.email, 'student');
        }

        // --- A√áILI≈û KONTROLLERƒ∞ (STRAVA VE OTO-Gƒ∞Rƒ∞≈û) ---
        window.onload = function() {
            // Admin Giri≈üi
            if(localStorage.getItem('adminLogged') === 'true') {
                ekranDegistir('admin'); adminListesiniYukle(); loadBugReports();
            }
            
            // √ñƒürenci Giri≈üi ve Strava Yakalama
            auth.onAuthStateChanged(function(user) {
                if (user && localStorage.getItem('adminLogged') !== 'true') { 
                    
                    // Strava Token Kontrol√º
                    const urlParams = new URLSearchParams(window.location.search);
                    const stravaToken = urlParams.get('strava_token');
                    
                    if (stravaToken) {
                        db.collection("users").doc(user.email).update({
                            stravaConnected: true,
                            stravaAccessToken: stravaToken
                        }).then(() => {
                            window.history.replaceState({}, document.title, "/");
                            alert("‚úÖ Strava Ba≈üarƒ±yla Baƒülandƒ±!");
                            location.href = "/"; // Sayfayƒ± yenile
                        });
                    } else {
                        loadStudentData(user.email); // Normal veri y√ºkleme
                    }
                }
            });
        };

        // --- FONKSƒ∞YONLAR ---
        function sendMail(toEmail, subject, message) {
            if(EMAILJS_PUBLIC_KEY === "USER_ID_BURAYA") return;
            const templateParams = { to_email: toEmail, subject: subject, message: message };
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        }

        function openBugModal() { document.getElementById('bugModal').style.display = 'flex'; }
        function closeBugModal() { document.getElementById('bugModal').style.display = 'none'; }
        function sendBugReport() {
            const note = document.getElementById('bugText').value;
            if(!note) return alert("L√ºtfen yazƒ±n.");
            const user = auth.currentUser ? auth.currentUser.email : "Giri≈ü Ekranƒ±";
            db.collection("bug_reports").add({ user: user, note: note, time: new Date() }).then(() => {
                alert("G√∂nderildi! ‚úÖ"); document.getElementById('bugText').value = ""; closeBugModal();
            });
        }

        // Giri≈ü
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;

            if(email === 'admin@cp.com') {
                if(password === 'Pepereina.26') {
                    if(rememberMe) localStorage.setItem('adminLogged', 'true');
                    ekranDegistir('admin'); adminListesiniYukle(); loadBugReports();
                } else alert("‚ùå Hata: Admin ≈üifresi yanlƒ±≈ü!");
                return;
            }

            const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
            auth.setPersistence(persistence).then(() => {
                return auth.signInWithEmailAndPassword(email, password);
            }).catch(err => alert("Giri≈ü Hatasƒ±: " + err.message));
        });

        // Veri Y√ºkleme
        function loadStudentData(email) {
            db.collection("users").doc(email).get().then(doc => {
                if(doc.exists) {
                    ekranDegistir('ogrenci');
                    const veri = doc.data();
                    document.getElementById('studentNameTitle').innerText = "Merhaba, " + veri.isim.split(' ')[0];
                    document.getElementById('pBoy').value = veri.boy || "";
                    document.getElementById('pKilo').value = veri.kilo || "";
                    document.getElementById('pYas').value = veri.yas || "";
                    document.getElementById('pHedef').value = veri.hedef || "";
                    
                    // Strava Buton Durumu
                    const stravaBtn = document.getElementById('stravaConnectBtn');
                    if (veri.stravaConnected && stravaBtn) {
                        stravaBtn.innerHTML = "‚úÖ Strava Baƒülƒ±";
                        stravaBtn.style.background = "#4caf50";
                        stravaBtn.href = "#"; 
                        stravaBtn.style.pointerEvents = "none";
                    }

                    const historyRef = db.collection("users").doc(email).collection("history");
                    historyRef.doc(bugun).onSnapshot(doc => {
                        if(doc.exists) {
                            const data = doc.data();
                            document.getElementById('workoutDisplay').innerText = data.program;
                            if(data.stravaLink) document.getElementById('stravaLinkInput').value = data.stravaLink;
                            if(data.durum === 'rest') document.getElementById('workoutDisplay').innerHTML = "üí§ <strong>Dinlenme G√ºn√º</strong><br>V√ºcudunu dinle.";
                        } else {
                            document.getElementById('workoutDisplay').innerText = "Bug√ºn antrenman yok.";
                        }
                    });
                    studentCalDate = new Date(); studentCalView = 'week';
                    renderUniversalCalendar(email, 'student');
                    historyRef.where("durum", "==", "tamamlandi").get().then(snap => {
                        document.getElementById('streakCount').innerText = snap.size;
                    });
                } else { auth.signOut(); }
            });
        }

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            auth.createUserWithEmailAndPassword(email, password).then(() => {
                db.collection("users").doc(email).set({ isim: name, email: email, rol: 'ogrenci' }).then(() => {
                    alert("Kayƒ±t ba≈üarƒ±lƒ±! Giri≈ü yap."); auth.signOut(); ekranDegistir('giris');
                });
            }).catch(err => alert("Hata: " + err.message));
        });

        // Harici Aktivite
        function hariciEkle() {
            const type = document.getElementById('extraType').value;
            const note = document.getElementById('extraNote').value;
            if(!note) { alert("S√ºre/Not gir."); return; }
            const user = auth.currentUser; if(!user) return;
            const text = `‚ûï ${type} (${note})`;
            db.collection("users").doc(user.email).collection("history").doc(bugun).get().then(doc => {
                if(doc.exists) {
                    let data = doc.data();
                    let newExtra = data.ekstra ? data.ekstra + ", " + text : text;
                    let newStatus = (data.durum === 'rest') ? 'active-rest' : 'tamamlandi';
                    db.collection("users").doc(user.email).collection("history").doc(bugun).update({ ekstra: newExtra, durum: newStatus });
                } else {
                    db.collection("users").doc(user.email).collection("history").doc(bugun).set({
                        tarih: bugun, program: "Serbest Aktivite", durum: "tamamlandi", ekstra: text
                    });
                }
            }).then(() => { 
                alert("Eklendi! üßò"); renderUniversalCalendar(user.email, 'student'); 
                sendMail(COACH_EMAIL, "Ekstra Aktivite", user.email + " harici aktivite ekledi: " + text);
            });
        }

        function setRestDay() {
            const id = document.getElementById('studentSelect').value;
            if(!id) return;
            db.collection("users").doc(id).collection("history").doc(bugun).set({
                program: "Rest Day (Dinlenme)", durum: "rest", tarih: bugun
            }).then(() => { alert("OFF DAY üí§"); secilenOgrenciyiGetir(); });
        }

        // Takvim Render (√ñzetlenmi≈ü)
        function renderUniversalCalendar(email, role) {
            let currentDate = (role === 'student') ? studentCalDate : adminCalDate;
            let currentView = (role === 'student') ? studentCalView : adminCalView;
            let gridId = (role === 'student') ? 'calendarGridStudent' : 'calendarGridAdmin';
            let listId = (role === 'student') ? 'studentHistoryTable' : 'adminHistoryTable';
            let titleId = (role === 'student') ? 'calTitleStudent' : 'calTitleAdmin';

            const grid = document.getElementById(gridId);
            const list = document.getElementById(listId);
            const title = document.getElementById(titleId);
            grid.innerHTML = "Y√ºkleniyor..."; list.innerHTML = "";

            let startDate;
            if (currentView === 'week') {
                let day = currentDate.getDay(); let diff = currentDate.getDate() - day + (day == 0 ? -6 : 1); 
                startDate = new Date(currentDate); startDate.setDate(diff);
                let displayMonth = startDate.toLocaleDateString('tr-TR', { month: 'long' });
                title.innerText = `${startDate.getDate()} - ${new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()+6).getDate()} ${displayMonth}`;
            } else {
                startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                let displayMonth = startDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
                title.innerText = displayMonth;
            }

            db.collection("users").doc(email).collection("history").get().then(snapshot => {
                let historyMap = {};
                snapshot.forEach(doc => { historyMap[doc.id] = doc.data(); });
                grid.innerHTML = "";
                
                // Takvim D√∂ng√ºs√º (Haftalƒ±k veya Aylƒ±k)
                let loopCount = (currentView === 'week') ? 7 : new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
                let firstDayIndex = startDate.getDay(); if(firstDayIndex===0) firstDayIndex=7;
                
                if(currentView === 'month') for(let i=1; i<firstDayIndex; i++) grid.innerHTML += `<div class="day-card day-other-month"></div>`;

                for(let i=0; i<loopCount; i++) {
                    let d = new Date(startDate); 
                    if(currentView==='week') d.setDate(startDate.getDate() + i);
                    else d.setDate(i+1);
                    
                    let y = d.getFullYear(); let m = String(d.getMonth()+1).padStart(2,'0'); let dd = String(d.getDate()).padStart(2,'0');
                    let dateStr = `${y}-${m}-${dd}`;
                    
                    let statusClass = ""; let content = "";
                    if(dateStr === bugun) statusClass += " day-today";
                    let hasData = false; let item = null;

                    if(historyMap[dateStr]) {
                        hasData = true; item = historyMap[dateStr];
                        if(item.durum === 'tamamlandi') { statusClass += " day-done"; content = "‚úÖ"; }
                        else if(item.durum === 'rest') { statusClass += " day-rest"; content = "üí§"; }
                        else if(item.durum === 'active-rest') { statusClass += " day-active-rest"; content = "üßò"; }
                        else { statusClass += " day-missed"; content = "üî¥"; }
                    }
                    
                    let dayLabel = (currentView === 'month') ? i+1 : parseInt(dd);
                    let htmlContent = (currentView === 'month') ? `<span style="font-weight:bold">${dayLabel}</span><br>${content}` : `<div style="margin-bottom:2px; color:#888">${dayLabel}</div><div>${content}</div>`;
                    
                    grid.innerHTML += `<div class="day-card ${statusClass}" onclick="alert('Tarih: ${dateStr}')">${htmlContent}</div>`;

                    // Listeye Ekle
                    if(hasData) {
                        let stravaHtml = item.stravaLink ? `<a href="${item.stravaLink}" target="_blank" class="strava-btn">Strava</a>` : "";
                        let statusBadge = "";
                        if(item.durum === 'tamamlandi') statusBadge = `<span class="status-badge bg-green">Yapƒ±ldƒ±</span>`;
                        else if(item.durum === 'rest') statusBadge = `<span class="status-badge bg-gray">Off Day</span>`;
                        else if(item.durum === 'active-rest') statusBadge = `<span class="status-badge bg-purple">Aktif</span>`;
                        else statusBadge = `<span class="status-badge bg-red">Bekliyor</span>`;
                        
                        let yorumBtn = (role === 'admin') ? `<button class="comment-btn" onclick="yorumEkle('${email}', '${dateStr}')">‚úèÔ∏è Yorum</button>` : "";
                        let yorumGoster = item.kocYorumu ? `<span class="coach-note">üí¨ ${item.kocYorumu}</span>` : "";
                        let ekstraGoster = item.ekstra ? `<span class="extra-activity">${item.ekstra}</span>` : "";
                        
                        list.innerHTML += `<tr><td style="width:80px;">${dateStr}</td><td><div>${item.program.substring(0,25)}...</div>${ekstraGoster}${stravaHtml} ${yorumGoster}</td><td style="text-align:right;">${statusBadge}<br>${yorumBtn}</td></tr>`;
                    }
                }
                if(list.innerHTML === "") list.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#666;'>Bu d√∂nemde kayƒ±t yok.</td></tr>";
            });
        }

        function changeViewStudent(view) { studentCalView = view; document.getElementById('btnViewWeekStudent').classList.toggle('active', view === 'week'); document.getElementById('btnViewMonthStudent').classList.toggle('active', view === 'month'); renderUniversalCalendar(auth.currentUser.email, 'student'); }
        function changeDateStudent(delta) { if(studentCalView === 'week') studentCalDate.setDate(studentCalDate.getDate() + (delta * 7)); else studentCalDate.setMonth(studentCalDate.getMonth() + delta); renderUniversalCalendar(auth.currentUser.email, 'student'); }
        function changeViewAdmin(view) { adminCalView = view; document.getElementById('btnViewWeekAdmin').classList.toggle('active', view === 'week'); document.getElementById('btnViewMonthAdmin').classList.toggle('active', view === 'month'); if(adminSelectedUserEmail) renderUniversalCalendar(adminSelectedUserEmail, 'admin'); }
        function changeDateAdmin(delta) { if(adminCalView === 'week') adminCalDate.setDate(adminCalDate.getDate() + (delta * 7)); else adminCalDate.setMonth(adminCalDate.getMonth() + delta); if(adminSelectedUserEmail) renderUniversalCalendar(adminSelectedUserEmail, 'admin'); }
        function loadBugReports() { const list = document.getElementById('bugReportList'); list.innerHTML = "Y√ºkleniyor..."; db.collection("bug_reports").orderBy("time", "desc").get().then(snap => { list.innerHTML = ""; if(snap.empty) { list.innerHTML = "<p style='color:#666; font-size:12px;'>Hen√ºz bildirim yok.</p>"; return; } snap.forEach(doc => { let data = doc.data(); let dateDisplay = "Tarih Yok"; if(data.time && data.time.toDate) { dateDisplay = data.time.toDate().toLocaleString(); } list.innerHTML += `<div class="bug-item"><div class="bug-meta">üë§ ${data.user} | üïí ${dateDisplay}</div><div>${data.note}</div></div>`; }); }); }
        function profiliGuncelle() { const user = auth.currentUser; if(user) db.collection("users").doc(user.email).update({ boy: document.getElementById('pBoy').value, kilo: document.getElementById('pKilo').value, yas: document.getElementById('pYas').value, hedef: document.getElementById('pHedef').value }).then(() => alert("Kaydedildi.")); }
        function goreviTamamla() { const user = auth.currentUser; const stravaLink = document.getElementById('stravaLinkInput').value; if(user) { db.collection("users").doc(user.email).collection("history").doc(bugun).update({ durum: 'tamamlandi', tamamlanmaZamani: new Date(), stravaLink: stravaLink }).then(() => { alert("Kaydedildi! ‚úÖ"); renderUniversalCalendar(user.email, 'student'); sendMail(COACH_EMAIL, "Tamamlandƒ±", user.email + " antrenmanƒ± bitirdi."); }).catch(() => alert("Bug√ºn program yok.")); } }
        function yorumEkle(email, tarih) { const yorum = prompt("Yorumun:"); if(yorum) { db.collection("users").doc(email).collection("history").doc(tarih).update({ kocYorumu: yorum }).then(() => { renderUniversalCalendar(email, 'admin'); }); } }
        function adminListesiniYukle() { const select = document.getElementById('studentSelect'); select.innerHTML = "<option>Y√ºkleniyor...</option>"; db.collection("users").where("rol", "==", "ogrenci").get().then(snap => { select.innerHTML = ""; snap.forEach(doc => { let opt = document.createElement('option'); opt.value = doc.id; opt.text = doc.data().isim; select.appendChild(opt); }); secilenOgrenciyiGetir(); }); }
        function secilenOgrenciyiGetir() { const id = document.getElementById('studentSelect').value; if(!id) return; adminSelectedUserEmail = id; adminCalDate = new Date(); db.collection("users").doc(id).get().then(doc => { document.getElementById('studentStats').style.display = 'block'; document.getElementById('studentStats').innerHTML = `Boy: ${doc.data().boy} | Kilo: ${doc.data().kilo}`; db.collection("users").doc(id).collection("history").doc(bugun).get().then(hDoc => { if(hDoc.exists) document.getElementById('workoutInput').value = hDoc.data().program; else document.getElementById('workoutInput').value = ""; }); renderUniversalCalendar(id, 'admin'); }); }
        function kaydet() { const id = document.getElementById('studentSelect').value; const prog = document.getElementById('workoutInput').value; if(!id) return; db.collection("users").doc(id).collection("history").doc(bugun).set({ program: prog, durum: 'bekliyor', tarih: bugun }).then(() => { alert("Yayƒ±nlandƒ±!"); secilenOgrenciyiGetir(); sendMail(id, "Yeni Program", "Ko√ßun yeni program yazdƒ±."); }); }
        function ogrenciyiSil(){ if(confirm("Sil?")) { db.collection("users").doc(document.getElementById('studentSelect').value).delete().then(()=>adminListesiniYukle()); } }
        function sablonuUygula() { const val = document.getElementById('templateSelect').value; const s = { "baslangic": "üî∞ BA≈ûLANGI√á\n- 10dk Y√ºr√ºy√º≈ü\n- 3x12 Squat", "kardiyo": "üî• KARDƒ∞YO\n- 20dk Ko≈üu", "bacak": "ü¶µ BACAK\n- 4x12 Squat", "longrun": "üèÉ UZUN KO≈ûU\n- 60dk Ko≈üu", "interval": "‚ö° ƒ∞NTERVAL\n- 8x 2dk Hƒ±zlƒ±" }; if(s[val]) document.getElementById('workoutInput').value = s[val]; }
        function cikisYap() { localStorage.removeItem('adminLogged'); auth.signOut().then(() => location.reload()); }
    </script>
</body>
</html>